<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./config.js"></script>
    <!-- <script src="https://cdn.ronghub.com/RongIMLib-5.0.1.prod.js"></script> -->
    <script src="./dist/RongIMLib-5.0.3.js"></script>
    <!-- <script src="./assets/js/RongIMLib-5.0.0.prod.js"></script> -->
</head>

<body>
    <p>
    <p>文件上传后，可以在全局获取 file</p>
    <input type="file" name="" id="file" onchange="handelChange(event)">
    </p>
    <div>
        <button onclick="handelSend(1)">发送单聊消息</button>
        <button onclick="handelSend(3)">发送群组消息</button>
        <h6>特殊操作：</h6>
        <p>消息扩展<button onclick="handelSendAndUpdateExpansion()">发送&更新带扩展的消息</button></p>
        <p>群聊消息回执<button onclick="handelSendRRReq()">发送群消息 并 发送群响应回执请求</button></p>
        <button onclick="handelAddWatch()">添加监听</button>
        <button onclick="handelRemoveWatch()">移除监听</button>
    </div>
    <script>
        // const appkey = "8brlm7uf8ozt3"
        // const token = "2v8tmW2mQLXfViA2C6p0Jm1hC0xv/+xhxFY4yoL9rhg=@vyzw.cn.rongnav.com;vyzw.cn.rongcfg.com"
        const { appkey, token, groupId, targetId } = Config
        // 应用初始化以获取 RongIMLib 实例对象，请务必保证此过程只被执行一次,连接类型推荐使用comet
        RongIMLib.init({ appkey });

        // 添加事件监听

        const Events = RongIMLib.Events
        RongIMLib.addEventListener(Events.CONNECTING, function () {
            console.log("正在链接服务器");
        });

        RongIMLib.addEventListener(Events.CONNECTED, function () {
            console.log("已经链接到服务器");
        });

        RongIMLib.addEventListener(Events.MESSAGES, function (messages) {
            console.log(new Date().toISOString(), "消息监听：", messages);
        });

        /**
         * 手动调用 disconnect 方法或者用户被踢下线 会触发这个事件
         */
        RongIMLib.addEventListener(Events.DISCONNECT, () => {
            console.log("连接中断，需要业务层进行重连处理");
        });

        /**
         * 链接出问题时，内部进行重新链接，会出发这个事件
         */
        RongIMLib.addEventListener(Events.SUSPEND, () => {
            console.log("链接中断，SDK 会尝试重连，业务层无需关心");
        });
        // 设置输入状态事件监听
        RongIMLib.addEventListener(Events.TYPING_STATUS, (event) => {
            console.log("设置输入状态事件监听", event.status);
        });

        // 扩展事件监听
        RongIMLib.addEventListener(Events.EXPANSION, (event) => {
            console.log("扩展事件监听", event);
        });

        RongIMLib.addEventListener(Events.CHATROOM, (event) => {
            console.warn("chatroom", event);
        });

        RongIMLib.addEventListener(Events.CONVERSATION, (event) => {
            console.log("会话监听：", event);
        });

        RongIMLib.addEventListener(Events.MESSAGE_RECEIPT_REQUEST, ({ conversation, messageUId }) => {
            console.log('rrq 消息回执请求监听事件', conversation, messageUId)
        });

        RongIMLib.addEventListener(Events.MESSAGE_RECEIPT_RESPONSE, (res) => {
            const { conversation, messageUIdList, receivedUserId } = res;
            console.log(res)
            console.log("rrs 消息回执响应监听事件", conversation, messageUIdList, receivedUserId)
        });

        RongIMLib.connect(token).then((res) => {
            if (res.code === 0) {
                console.log("userId:", res.data.userId)
            }
        })


        function handelChange(params) {
            console.log(params)
            window.file = params.target.files[0];
        }

        function handelSendAndUpdateExpansion() {
            const message = new RongIMLib.TextMessage({ content: '测试发送扩展消息' })
            // 发送消息
            RongIMLib.sendMessage({ conversationType: 3, targetId: 'group1' }, message, { canIncludeExpansion: true, expansion: { key: 'value' } }).then(res => {
                console.log("发送消息成功->", res)
                let conversation = {
                    conversationType: res.data.conversationType || res.data.type,
                    targetId: res.data.targetId
                }
                // 更新扩展
                RongIMLib.updateMessageExpansion({ key1: 'val1', key2: 'val2', ...conversation }, res.data).then(res => {
                    if (res.code === 0) {
                        console.log(res, '更新成功')
                    } else {
                        console.log(res.code, res.msg)
                    }
                })
            })

        }

        function handelSendRRReq() {
            const conversation = { conversationType: 3, targetId: 'group1' }
            // 实例化待发送消息，RongIMLib.TextMessage 为内置文本型消息
            const message = new RongIMLib.TextMessage({ content: '发送群组回执测试消息' })
            // 发送
            RongIMLib.sendMessage(conversation, message).then(resp => {
                console.log("发送消息成功：", resp.data)
                RongIMLib.sendReadReceiptRequest(resp.data.targetId, resp.data.messageUId).then(res => {
                    if (res.code === 0) {
                        console.log("发送群回执请求成功：", res.code, res.data)
                    } else {
                        console.log(res.code, res.msg)
                    }
                }).catch(error => {
                    console.log(error)
                })
            })
        }


        function handelAddWatch(params) {
            RongIMLib.addEventListener(Events.MESSAGES, function (messages) {
                console.log("消息监听：", messages);
            });
        }

        function handelRemoveWatch(params) {
            console.log(handelRemoveWatch)
            RongIMLib.removeEventListeners(Events.MESSAGES);
        }

        function handelSend(conversationType) {
            const message = new RongIMLib.TextMessage({ content: '发送 test 群组消息' })
            // 发送消息
            RongIMLib.sendMessage({ conversationType, targetId: conversationType === 1 ? targetId : groupId }, message, { canIncludeExpansion: true, expansion: { key: 'value' } }).then(res => {
                console.log(new Date().toISOString(), "发送消息成功->", res)
                let conversation = {
                    conversationType: res.data.conversationType || res.data.type,
                    targetId: res.data.targetId
                }
            })
        }

    </script>
</body>

</html>