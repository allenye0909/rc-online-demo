<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./config.js"></script>
    <!-- è¶…çº§ç¾¤ 5.2.0 -->
    <!-- <script src="https://cdn.ronghub.com/RongIMLib-5.2.0.prod.js"></script> -->
    <script src="https://cdn.ronghub.com/RongIMLib-5.2.4.prod.js"></script>
    <!-- <script src="./dist/RongIMLib-5.0.3.js"></script> -->
    <!-- <script src="./assets/js/RongIMLib-5.0.0.prod.js"></script> -->
    <script src="https://cdn.ronghub.com/RongEmoji-2.2.10.js"></script>
</head>

<body>
    <p>
    <p>æ–‡ä»¶ä¸Šä¼ åï¼Œå¯ä»¥åœ¨å…¨å±€è·å– file</p>
    <input type="file" name="" id="file" class="banner-upload" onchange="handelChange(event)">
    <button onclick="handelClick()">handelClick</button>
    </p>
    <div>
        <button onclick="handelSend(1)">å‘é€å•èŠæ¶ˆæ¯</button>
        <button onclick="handelSend(3)">å‘é€ç¾¤ç»„æ¶ˆæ¯</button>
        <h6>ç‰¹æ®Šæ“ä½œï¼š</h6>
        <p>æ¶ˆæ¯æ‰©å±•<button onclick="handelSendAndUpdateExpansion()">å‘é€&æ›´æ–°å¸¦æ‰©å±•çš„æ¶ˆæ¯</button></p>
        <p>ç¾¤èŠæ¶ˆæ¯å›æ‰§<button onclick="handelSendRRReq()">å‘é€ç¾¤æ¶ˆæ¯ å¹¶ å‘é€ç¾¤å“åº”å›æ‰§è¯·æ±‚</button></p>
        <button onclick="handelAddWatch()">æ·»åŠ ç›‘å¬</button>
        <button onclick="handelRemoveWatch()">ç§»é™¤ç›‘å¬</button>
    </div>
    <script>
        // const appkey = "8brlm7uf8ozt3"
        // const token = "2v8tmW2mQLXfViA2C6p0Jm1hC0xv/+xhxFY4yoL9rhg=@vyzw.cn.rongnav.com;vyzw.cn.rongcfg.com"
        const { appkey, token, groupId, targetId, logLevel } = Config
        // åº”ç”¨åˆå§‹åŒ–ä»¥è·å– RongIMLib å®ä¾‹å¯¹è±¡ï¼Œè¯·åŠ¡å¿…ä¿è¯æ­¤è¿‡ç¨‹åªè¢«æ‰§è¡Œä¸€æ¬¡,è¿æ¥ç±»å‹æ¨èä½¿ç”¨comet
        RongIMLib.init({ appkey, logLevel });

        // æ·»åŠ äº‹ä»¶ç›‘å¬

        const Events = RongIMLib.Events
        RongIMLib.addEventListener(Events.CONNECTING, function () {
            console.log("æ­£åœ¨é“¾æ¥æœåŠ¡å™¨");
        });

        RongIMLib.addEventListener(Events.CONNECTED, function () {
            console.log("å·²ç»é“¾æ¥åˆ°æœåŠ¡å™¨");
            handelGetConversationList()
        });

        RongIMLib.addEventListener(Events.MESSAGES, function (messages) {
            console.log(new Date().toISOString(), "æ¶ˆæ¯ç›‘å¬ï¼š", messages);
        });

        /**
         * æ‰‹åŠ¨è°ƒç”¨ disconnect æ–¹æ³•æˆ–è€…ç”¨æˆ·è¢«è¸¢ä¸‹çº¿ ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶
         */
        RongIMLib.addEventListener(Events.DISCONNECT, () => {
            console.log("è¿æ¥ä¸­æ–­ï¼Œéœ€è¦ä¸šåŠ¡å±‚è¿›è¡Œé‡è¿å¤„ç†");
        });

        /**
         * é“¾æ¥å‡ºé—®é¢˜æ—¶ï¼Œå†…éƒ¨è¿›è¡Œé‡æ–°é“¾æ¥ï¼Œä¼šå‡ºå‘è¿™ä¸ªäº‹ä»¶
         */
        RongIMLib.addEventListener(Events.SUSPEND, () => {
            console.log("é“¾æ¥ä¸­æ–­ï¼ŒSDK ä¼šå°è¯•é‡è¿ï¼Œä¸šåŠ¡å±‚æ— éœ€å…³å¿ƒ");
        });
        // è®¾ç½®è¾“å…¥çŠ¶æ€äº‹ä»¶ç›‘å¬
        RongIMLib.addEventListener(Events.TYPING_STATUS, (event) => {
            console.log("è®¾ç½®è¾“å…¥çŠ¶æ€äº‹ä»¶ç›‘å¬", event.status);
        });

        // æ‰©å±•äº‹ä»¶ç›‘å¬
        RongIMLib.addEventListener(Events.EXPANSION, (event) => {
            console.log("æ‰©å±•äº‹ä»¶ç›‘å¬", event);
        });

        RongIMLib.addEventListener(Events.CHATROOM, (event) => {
            console.warn("chatroom", event);
            // æ–°å¢ç”¨æˆ·åŠ å…¥ã€é€€å‡ºèŠå¤©å®¤é€šçŸ¥èƒ½åŠ›ï¼Œéœ€è¦å®¢æˆ·å¼€é€šåæ”¯æŒï¼Œå¯æäº¤å·¥å•ç”³è¯·å¼€é€š
            // const o = {
            //     userChange: {
            //         users: {
            //             [senderUserId]: 1:join 0:quit
            //             [senderUserId]: message.messageType === 'RC:ChrmQuitNtf' ? ChatroomUserChangeType.QUIT : ChatroomUserChangeType.JOIN
            //         },
            //         chatroomId: message.targetId
            //     }
            // }
        });

        RongIMLib.addEventListener(Events.CONVERSATION, (event) => {
            console.log("ä¼šè¯ç›‘å¬ï¼š", event);
        });

        RongIMLib.addEventListener(Events.MESSAGE_RECEIPT_REQUEST, ({ conversation, messageUId }) => {
            console.log('rrq æ¶ˆæ¯å›æ‰§è¯·æ±‚ç›‘å¬äº‹ä»¶', conversation, messageUId)
        });

        RongIMLib.addEventListener(Events.MESSAGE_RECEIPT_RESPONSE, (res) => {
            const { conversation, messageUIdList, receivedUserId } = res;
            console.log(res)
            console.log("rrs æ¶ˆæ¯å›æ‰§å“åº”ç›‘å¬äº‹ä»¶", conversation, messageUIdList, receivedUserId)
        });

        RongIMLib.addEventListener(Events.ULTRA_GROUP_ENABLE, (event) => {
            console.log("ULTRA_GROUP_ENABLE", event);
        });

        RongIMLib.addEventListener(Events.ULTRA_GROUP_MESSAGE_EXPANSION_UPDATED, (event) => {
            console.log("ULTRA_GROUP_MESSAGE_EXPANSION_UPDATED", event);
        });

        RongIMLib.addEventListener(Events.ULTRA_GROUP_MESSAGE_MODIFIED, (event) => {
            console.log("ULTRA_GROUP_MESSAGE_MODIFIED", event);
        });

        RongIMLib.addEventListener(Events.ULTRA_GROUP_MESSAGE_RECALLED, (event) => {
            console.log("ULTRA_GROUP_MESSAGE_RECALLED", event);
        });

        RongIMLib.connect(token).then((res) => {
            if (res.code === 0) {
                console.log("userId:", res.data.userId)
            }
        })

        const randomString = function (e, t) { var r = []; for (e = e || 16, t = t || "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"; e--;)r.push(t[Math.floor(Math.random() * t.length)]); return r.join("") }

        function handelChange(params) {
            console.log(params)
            window.file = params.target.files[0];
        }

        function handelSendAndUpdateExpansion() {
            const message = new RongIMLib.TextMessage({ content: 'æµ‹è¯•å‘é€æ‰©å±•æ¶ˆæ¯' })
            const str = 'value: measurement; dimensions; size; magnitude; measure; admeasurement; bigness; fitting:'
            // å‘é€æ¶ˆæ¯
            const expansion = {
                emoji_action_list: "[{\"emojiStr\":\"ğŸ˜\",\"userIds\":[10003]},{\"emojiStr\":\"ğŸ˜\",\"userIds\":[10003]}]",
                local_message_id: "1650793585441"
            }
            // : { key: str } 
            RongIMLib.sendMessage({ conversationType: 3, targetId: 'group1' }, message, { canIncludeExpansion: true, expansion}).then(res => {
                console.log("å‘é€æ¶ˆæ¯æˆåŠŸ->", res)
                let conversation = {
                    conversationType: res.data.conversationType || res.data.type,
                    targetId: res.data.targetId
                }
                // æ›´æ–°æ‰©å±•
                RongIMLib.updateMessageExpansion({ key1: 'val1', key2: str, ...conversation }, res.data).then(res => {
                    if (res.code === 0) {
                        console.log(res, 'æ›´æ–°æˆåŠŸ')
                    } else {
                        console.log(res.code, res.msg)
                    }
                })
            })

        }

        function handelSendRRReq() {
            const conversation = { conversationType: 3, targetId: 'group1' }
            // å®ä¾‹åŒ–å¾…å‘é€æ¶ˆæ¯ï¼ŒRongIMLib.TextMessage ä¸ºå†…ç½®æ–‡æœ¬å‹æ¶ˆæ¯
            const message = new RongIMLib.TextMessage({ content: 'å‘é€ç¾¤ç»„å›æ‰§æµ‹è¯•æ¶ˆæ¯' })
            // å‘é€
            RongIMLib.sendMessage(conversation, message).then(resp => {
                console.log("å‘é€æ¶ˆæ¯æˆåŠŸï¼š", resp.data)
                RongIMLib.sendReadReceiptRequest(resp.data.targetId, resp.data.messageUId).then(res => {
                    if (res.code === 0) {
                        console.log("å‘é€ç¾¤å›æ‰§è¯·æ±‚æˆåŠŸï¼š", res.code, res.data)
                    } else {
                        console.log(res.code, res.msg)
                    }
                }).catch(error => {
                    console.log(error)
                })
            })
        }


        function handelAddWatch(params) {
            RongIMLib.addEventListener(Events.MESSAGES, function (messages) {
                console.log("æ¶ˆæ¯ç›‘å¬ï¼š", messages);
            });
        }

        function handelRemoveWatch(params) {
            console.log(handelRemoveWatch)
            RongIMLib.removeEventListeners(Events.MESSAGES);
        }

        function handelSend(conversationType) {
            const message = new RongIMLib.TextMessage({ content: 'å‘é€ test ç¾¤ç»„æ¶ˆæ¯' })
            // å‘é€æ¶ˆæ¯
            RongIMLib.sendMessage({ conversationType, targetId: conversationType === 1 ? targetId : groupId }, message, { canIncludeExpansion: true, expansion: { key: 'value' } }).then(res => {
                console.log(new Date().toISOString(), "å‘é€æ¶ˆæ¯æˆåŠŸ->", res)
                let conversation = {
                    conversationType: res.data.conversationType || res.data.type,
                    targetId: res.data.targetId
                }
            })
        }

        function handelGetConversationList() {
            const startTime = 0;
            const count = 10;
            const order = 0;

            RongIMLib.getConversationList({
                count: count,
                startTime: startTime,
                order: order
            }).then(res => {
                if (res.code === 0) {
                    console.log(res.code, res.data)
                } else {
                    console.log(res.code, res.msg)
                }
            })
        }


        function handelClick() {
            document
                .querySelector(".banner-upload")
                .click()
        }
    </script>
</body>

</html>